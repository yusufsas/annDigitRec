<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>28x28 Çizim Tanıma</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    #drawingCanvas {
      border: 2px solid #dee2e6;
      border-radius: 0.5rem;
      cursor: crosshair;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
      background-color: black;
    }
  </style>
</head>
<body class="bg-light">

  <div class="container py-5">
    <div class="text-center mb-4">
      <h1 class="text-primary fw-bold">Çizim Tanıma Aracı</h1>
      <p class="text-muted">Beyaz renkle çizim yapın veya bir görsel yükleyin, ardından tahminleri alın.</p>
    </div>

    <div class="row justify-content-center mb-4">
      <div class="col-md-6 text-center">
        <canvas id="drawingCanvas" width="280" height="280" class="mb-3"></canvas>

        <form id="imageForm" method="POST" action="{% url 'index' %}">
          {% csrf_token %}
          <input type="hidden" name="image_data" id="imageDataInput">
          
          <!-- Görsel Yükleme Butonu -->
          <div class="mb-3">
            <input type="file" accept="image/*" class="form-control" id="uploadInput" onchange="handleImageUpload(event)">
          </div>

          <div class="d-flex justify-content-center gap-3 mt-2">
            <button type="button" class="btn btn-success" onclick="submitDrawing()">Çizimi Gönder</button>
            <button type="button" class="btn btn-outline-primary" onclick="submitUpload()">Yüklenen Görseli Gönder</button>
            <button type="button" class="btn btn-outline-danger" onclick="clearCanvas()">Temizle</button>
          </div>
        </form>
      </div>
    </div>

    <div class="row justify-content-center">
      <div class="col-md-8">
        <div class="card shadow-sm">
          <div class="card-body text-center">
            <h4 class="card-title mb-4 text-primary">Tahmin Sonuçları</h4>
            <p class="mb-2"><strong>CNN Model Tahmini:</strong> <span class="text-dark">{{ pred_cnn }}</span></p>
            <p class="mb-2"><strong>YSA Model 1 Tahmini:</strong> <span class="text-dark">{{ pred_ysa1 }}</span></p>
            <p class="mb-0"><strong>YSA Model 2 Tahmini:</strong> <span class="text-dark">{{ pred_ysa2 }}</span></p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    const canvas = document.getElementById('drawingCanvas');
    const ctx = canvas.getContext('2d');
    const gridSize = 28;
    const cellSize = 10;
    let isDrawing = false;

    function setBrushSettings() {
      ctx.lineWidth = 32;
      ctx.lineCap = 'round';
      ctx.strokeStyle = '#fff';
    }

    function drawGrid() {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      ctx.fillStyle = 'black'; 
      ctx.fillRect(0, 0, canvas.width, canvas.height);
    }

    function clearCanvas() {
      drawGrid();
      setBrushSettings();
    }

    drawGrid();
    setBrushSettings();

    canvas.addEventListener('mousedown', (e) => {
      isDrawing = true;
      ctx.beginPath();
      ctx.moveTo(e.offsetX, e.offsetY);
    });

    canvas.addEventListener('mousemove', (e) => {
      if (isDrawing) {
        ctx.lineTo(e.offsetX, e.offsetY);
        ctx.stroke();
      }
    });

    canvas.addEventListener('mouseup', () => isDrawing = false);
    canvas.addEventListener('mouseleave', () => isDrawing = false);

    function submitDrawing() {
      const tempCanvas = document.createElement('canvas');
      tempCanvas.width = 28;
      tempCanvas.height = 28;
      const tempCtx = tempCanvas.getContext('2d');
      tempCtx.fillStyle = 'white';
      tempCtx.fillRect(0, 0, 28, 28);
      tempCtx.drawImage(canvas, 0, 0, 280, 280, 0, 0, 28, 28);

      const dataURL = tempCanvas.toDataURL('image/png');
      document.getElementById('imageDataInput').value = dataURL;
      document.getElementById('imageForm').submit();
    }

    function handleImageUpload(event) {
      const file = event.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = function(e) {
        const imageData = e.target.result;
        document.getElementById('imageDataInput').value = imageData;
      };
      reader.readAsDataURL(file);
    }

    function submitUpload() {
      const data = document.getElementById('imageDataInput').value;
      if (!data) {
        alert("Lütfen önce bir görsel yükleyin.");
        return;
      }
      document.getElementById('imageForm').submit();
    }
  </script>

</body>
</html>
